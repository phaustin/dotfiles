
(setq load-path (cons (expand-file-name "~phil/elisp") load-path))


(when (locate-library "edit-server")
  (require 'edit-server)
  (setq edit-server-new-frame 1)
  (edit-server-start))

(setq default-directory "~/repos") 

(setq load-path (cons (expand-file-name "~phil/elisp/notes-mode/lisp") load-path))

(setq load-path (cons (expand-file-name "~phil/elisp/mailcrypt/share/emacs/site-lisp") load-path))

(setq load-path (cons (expand-file-name "~phil/elisp/misc") load-path))

(require 'shell-command)
(shell-command-completion-mode)

(require 'bash-completion)
(bash-completion-setup)


(load-library "mailcrypt")
(mc-setversion "gpg") ;; Alternately, "2.6" or "gpg"

(define-key global-map "\C-xx" 'abbrev-mode)
(setq save-abbrevs t)
;(quietly-read-abbrev-file) 
(setq message-log-max 500)
(setq log-message-max-size 500)
(load-file "~/elisp/misc/my-text.el")
(load-file "~/elisp/misc/my-latex.el")


(add-hook 'LaTeX-mode-hook
	  (lambda ()
	    (quietly-read-abbrev-file "/Users/phil/.abbrev_defs")
	    (setq local-abbrev-table LaTeX-mode-abbrev-table)
 	    (abbrev-mode t)
 	    ))

(setq-default abbrev-mode t)                            ; enable abbreviations
(setq save-abbrevs t)                                   ; save abbreviations upo

; Tell XEmacs to load `my-latex.el' when opening LaTeX files
(add-hook 'LaTeX-mode-hook
  '(lambda()
     (load-file "~/elisp/misc/my-latex.el")  ; load these LaTeX preferences
     ))
(setq-default abbrev-mode t)                            ; enable abbreviations
(setq save-abbrevs t)                                   ; save abbreviations upon exiting xemacs
;;(setq abbrev-file-name "~/.xemacs/my-abbreviations.el") ; the file storing the abbreviations
(if (file-readable-p abbrev-file-name)                  ; read the abbreviations every
  (read-abbrev-file abbrev-file-name)                   ; time xemacs is started
  )

(require 'notes-variables)
(setq auto-mode-alist
  	(cons (cons "/9[0-9][0-9][0-9][0-9][0-9].?$" 'notes-mode)
  	      auto-mode-alist))
(define-key global-map "\C-cn" 'notes-index-todays-link)
(define-key global-map [(control c) (return)] 'notes-w3-follow-link)

;(setq auto-mode-alist (cons '("\\.txt\\'" . notes-mode) auto-mode-alist))
(setq auto-mode-alist (cons '("\\.nm\\'" . notes-mode) auto-mode-alist))

(load-library "mailcrypt")

(put 'upcase-region 'disabled nil)

(require 'package)
(add-to-list 'package-archives '("marmalade" . "http://marmalade-repo.org/packages/"))
(add-to-list 'package-archives '("melpa" . "http://melpa.milkbox.net/packages/") t)
(package-initialize)
;(require 'yasnippet)
;(yas-global-mode 1)

;; Bind this to control-X w (normally undefined):
(setq browse-url-browser-function 'browse-url-firefox)


(setenv "or" "/Users/phil/repos/org")
;http://ergoemacs.org/emacs/emacs_env_var_paths.html

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(browse-url-firefox-program "/Users/phil/bin/chromebash")
 '(exec-path
   (quote
    ("/usr/bin" "/bin" "/usr/sbin" "/sbin" "/usr/local/Cellar/emacs/24.3/libexec/emacs/24.3/x86_64-apple-darwin12.5.0" "/usr/local/bin")) nil nil "http://ergoemacs.org/emacs/emacs_env_var_paths.html")
 '(ispell-local-dictionary "english")
 '(org-mobile-directory "~/orgtransfer")
 '(org-mobile-inbox-for-pull "~/repos/org/from-mobile.org")
 '(py-python-command-args (quote ("-i"))))

(global-set-key "\C-xw" browse-url-browser-function)


;from: http://trey-jackson.blogspot.com/2008/08/emacs-tip-25-shell-dirtrack-by-prompt.html
(add-hook 'shell-mode-hook
        #'(lambda ()
            (shell-dirtrack-mode nil)
            (add-hook 'comint-preoutput-filter-functions
                      'shell-sync-dir-with-prompt nil t)))

(defun shell-sync-dir-with-prompt (string)
"A preoutput filter function (see `comint-preoutput-filter-functions')
which sets the shell buffer's path to the path embedded in a prompt string.
This is a more reliable way of keeping the shell buffer's path in sync
with the shell, without trying to pattern match against all
potential directory-changing commands, ala `shell-dirtrack-mode'.

In order to work, your shell must be configured to embed its current
working directory into the prompt.  Here is an example .zshrc and .bashrc
snippet which turns this behavior on when running as an inferior Emacs shell:

zsh

  if [ $EMACS ]; then
     prompt='|Pr0mPT|%~|[%n@%m]%~%# '
  fi

The part that Emacs cares about is the '|Pr0mPT|%~|'
Everything past that can be tailored to your liking.
"
(if (string-match "|Pr0mPT|\\([^|]*\\)|" string)
    (let ((cwd (match-string 1 string)))
      (setq default-directory
            (if (string-equal "/" (substring cwd -1))
                cwd
              (setq cwd (concat cwd "/"))))
      (replace-match "" t t string 0))
  string))

(setq font-lock-maximum-decoration t)
(add-hook 'python-mode-hook 'turn-on-font-lock)

(setq-default calendar-latitude +49.2333)
(setq-default calendar-longitude -123.25)

(setq load-path (cons (expand-file-name "~phil/elisp/misc") load-path))
(load "plocal")        ; local functions for geography

(setq auto-mode-alist (append '(("\\.ht$" . rst-mode)) auto-mode-alist))
(setq auto-mode-alist (append '(("\\.rst$" . rst-mode)) auto-mode-alist))
(setq auto-mode-alist (append '(("\\.pyx$" . python-mode)) auto-mode-alist))
(setq auto-mode-alist (cons '("\\.nm\\'" . notes-mode) auto-mode-alist))
;(setq auto-mode-alist (cons '("\\.txt\\'" . notes-mode) auto-mode-alist))
(setq auto-mode-alist (cons '("\\.tex\\'" . latex-mode) auto-mode-alist))

(setq TeX-auto-save t)
(setq TeX-parse-self t)
(setq-default TeX-master nil)
(add-hook 'LaTeX-mode-hook 'visual-line-mode)
(add-hook 'LaTeX-mode-hook 'flyspell-mode)
(add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
(add-hook 'LaTeX-mode-hook 'turn-on-reftex)
(setq reftex-plug-into-AUCTeX t)

(setq TeX-view-program-selection
      '((output-pdf "PDF Viewer")))
(setq TeX-view-program-list
      '(("PDF Viewer" "xpdf %o")))
(setq TeX-PDF-mode t)

;(setq TeX-view-program-list
;  '(("preview" "open -a/Applications/Preview.app/Contents/MacOS/Preview %.pdf")))

(select-keys) ; choose-a-buffer for keys f3 and f9-f12

(global-set-key [f8] 'compile)
(global-set-key [f7] 'fill-paragraph)
(global-set-key [f6] 'auto-fill-mode) 
(global-set-key [f5] 'overwrite-mode) 
(global-set-key [f4] 'rst-mode) 
(global-set-key [f3] 'choose-python) 
(global-set-key [f2] 'choose-csh2) 
(global-set-key [f1] 'choose-csh1) 

(setq reftex-insert-label-flags '("se" "sfte"))
;(add-hook 'LaTeX-mode-hook 'turn-on-reftex)   ; with AUCTeX LaTeX mode
(setq reftex-enable-partial-scans t)
(setq reftex-save-parse-info t)
(setq reftex-use-multiple-selection-buffers t)
(setq reftex-plug-into-AUCTeX t)
(setq reftex-cite-format 'natbib)



(setq grep-command "grep -n -H -i ")


(defun choose-csh1 (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "csh1"))

(defun choose-csh2 (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "csh2"))

(defun choose-python (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "*ABI Ipython*"))


(defun choose-research (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "research.org"))


(defun choose-teaching (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "teaching.org"))

(defun choose-admin (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "admin.org"))

(defun choose-personal (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "personal.org"))

(defun choose-gtd (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "gtd.org"))

(defun choose-tasks (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "tasks.org"))

(defun choose-journal (&optional re-assign)
  "Set a key to a buffer"
  (interactive "P")
  (switch-to-buffer "journal.org"))


(make-shell "csh1")    ; Create a shell called "csh1"
(other-window 1)
(make-shell "csh2")    ; Create another shell in the other window

(setenv "PATH"
(concat "/Users/phil/miniconda/bin" ":" "/usr/texbin" ":" "/Users/phil/bin" ":" (getenv "PATH")))

(autoload 'send-region-to-omnifocus-quickentry "omnifocus" "Send the selected region to OmniFocus's Quick Entry window" t)
(global-set-key "\C-c\C-o" 'send-region-to-omnifocus-quickentry)
(put 'downcase-region 'disabled nil)

(require 'filladapt)
(setq-default filladapt-mode t)

(require 'show-wspace);
(add-hook 'font-lock-mode-hook 'highlight-tabs)

(load "highlight-region") ; prepend text to a region

(require 'package)
(add-to-list 'package-archives 
    '("marmalade" .
      "http://marmalade-repo.org/packages/"))

;(eval-after-load "geiser" '(require quack))

;(add-to-list 'load-path "~/emacs/org")
;(require 'org)

(add-to-list 'auto-mode-alist '("\\.org$" . org-mode))
'(define-key global-map "\C-cl" 'org-store-link)
(define-key global-map "\C-ca" 'org-agenda)
(setq org-log-done t)


; I prefer return to activate a link
 
(global-set-key "\C-cl" 'org-store-link)
(global-set-key "\C-ca" 'org-agenda)

(defun gtd ()
   (interactive)
   (find-file "~/repos/org/gtd.org")
)


(defun research ()
   (interactive)
   (find-file "~/repos/org/research.org")
)

(defun teaching ()
   (interactive)
   (find-file "~/repos/org/teaching.org")
)

(defun admin ()
   (interactive)
   (find-file "~/repos/org/admin.org")
)


(defun personal ()
   (interactive)
   (find-file "~/repos/org/personal.org")
)

(defun tasks ()
   (interactive)
   (find-file "~/repos/org/tasks.org")
)

(defun journal ()
   (interactive)
   (find-file "~/repos/org/journal.org")
)

(setq org-return-follows-link t)

(setq org-tags-exclude-from-inheritance '("PROJECT" "WAITING" "crypt"))
 

(setq org-return-follows-link t)
(setq org-agenda-files '("~/repos/org" "~/repos/bibs"))
 

(gtd)
(research)
(admin)
(teaching)
(personal)
(tasks)
(journal)


(global-set-key "\C-cp" 'choose-personal)
(global-set-key "\C-cr" 'choose-research)
(global-set-key "\C-ci" 'choose-teaching)
(global-set-key "\C-cw" 'choose-admin)
(global-set-key "\C-cg" 'choose-gtd)
(global-set-key "\C-ct" 'choose-tasks)
(global-set-key "\C-cj" 'choose-journal)


(setq org-todo-keywords
      (quote ((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d)")
              (sequence "WAITING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)" "PHONE" "MEETING"))))

(setq org-todo-keyword-faces
      (quote (("TODO" :foreground "red" :weight bold)
              ("NEXT" :foreground "blue" :weight bold)
              ("DONE" :foreground "forest green" :weight bold)
              ("WAITING" :foreground "orange" :weight bold)
              ("HOLD" :foreground "magenta" :weight bold)
              ("CANCELLED" :foreground "forest green" :weight bold)
              ("MEETING" :foreground "forest green" :weight bold)
              ("PHONE" :foreground "forest green" :weight bold))))

(setq org-use-fast-todo-selection t)

(setq org-treat-S-cursor-todo-selection-as-state-change nil)

(setq org-todo-state-tags-triggers
      (quote (("CANCELLED" ("CANCELLED" . t))
              ("WAITING" ("WAITING" . t))
              ("HOLD" ("WAITING" . t) ("HOLD" . t))
              (done ("WAITING") ("HOLD"))
              ("TODO" ("WAITING") ("CANCELLED") ("HOLD"))
              ("NEXT" ("WAITING") ("CANCELLED") ("HOLD"))
              ("DONE" ("WAITING") ("CANCELLED") ("HOLD")))))

(setq org-directory "~/repos/org")
(setq org-default-notes-file "~/repos/org/refile.org")

;; I use C-c c to start capture mode
(global-set-key (kbd "C-c c") 'org-capture)

(put 'dired-find-alternate-file 'disabled nil)

;;https://github.com/jhelwig/ack-and-a-half
;;http://beyondgrep.com/
;;curl http://beyondgrep.com/ack-2.10-single-file > ~/bin/ack && chmod 0755 !#:3
;;(add-to-list 'load-path "/path/to/ack-and-a-half")
(require 'ack-and-a-half)
;; Create shorter aliases
(defalias 'ack 'ack-and-a-half)
(defalias 'ack-same 'ack-and-a-half-same)
(defalias 'ack-find-file 'ack-and-a-half-find-file)
(defalias 'ack-find-file-same 'ack-and-a-half-find-file-same)
(setq ack-and-a-half-executable "/Users/phil/bin/ack")

(defvar server-buffer-clients)
(when (and (fboundp 'server-start) (string-equal (getenv "TERM") 'xterm))
  (server-start)
  (defun fp-kill-server-with-buffer-routine ()
    (and server-buffer-clients (server-done)))
  (add-hook 'kill-buffer-hook 'fp-kill-server-with-buffer-routine))

(server-start)

(setq-default ispell-program-name "/usr/local/bin/ispell")
(setq auto-mode-alist (cons '("\\.txt\\'" . text-mode) auto-mode-alist))

(setq org-agenda-start-day "-2d")
(setq org-agenda-span 10)


(setq org-capture-templates
      '(("t" "Todo" entry (file+headline "~/repos/org/refile.org" "Tasks")
             "* TODO %?    \n  %i\n  %a")
       ("n" "Note" entry  (file+headline "~/repos/org/refile.org" "Notes")
             "* %?   :NOTE: \n  %i\n  %a")))

(setq org-agenda-custom-commands
      '(("p" "Project List"
          ( (tags "PROJECT")
          )
        )
        ("w" tags-todo "WAITING" nil) 
        ("f" todo "FILED" nil) 
        ("n" todo "NEXT" nil)
        ("o" tags "NOTE" nil)
        ("d" "Agenda + Next Actions" ((agenda) (todo "NEXT")))
        ("O" "Office"
          ( (agenda)
            (tags-todo "OFFICE")
          )
        )
        ("W" "Weekly Plan"
          ( (agenda)
            (todo "TODO")
            (tags "PROJECT")
          )
        )
        ("H" "Home Lists"
          ( (agenda)
            (tags-todo "HOME")
            (tags-todo "COMPUTER")
          )
        )
       )
  )


(require 'org-crypt)
(org-crypt-use-before-save-magic)
;; GPG key to use for encryption
;; Either the Key ID or set to nil to use symmetric encryption.
(setq org-crypt-key nil)

(load-library "browse-yank")
(global-set-key "\C-x\C-y" 'browse-yank)


(add-to-list 'load-path "~phil/elisp/python-mode.el-6.1.3") 
(autoload 'python-mode "python-mode" "Python Mode." t)
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-mode))
(add-to-list 'interpreter-mode-alist '("python" . python-mode))

(setq py-shell-name "/Users/phil/miniconda/bin/ipython")
(require 'python-mode)
